# ti.macos.panels

Titanium native module for Mac Catalyst file panels.

## Description

`ti.macos.panels` wraps Apple native panels with a JavaScript API:

- `NSOpenPanel` for open/select actions
- `NSSavePanel` for save destination actions

The module only supports Mac Catalyst and uses one shared result contract with consistent `ERR_*` codes across methods.

## Features

- Select one folder, one file, or many files
- Document-named variants (`openDocument`, `openDocuments`)
- Save destination picker (`saveFile`)
- Same callback result shape for every API
- Standard `ERR_*` error catalog
- Option validation (including invalid path/type checks)
- File filters with extensions and UTType identifiers

## Compatibility

- **Titanium SDK**: `13.2.0` (local/fork build with Mac Catalyst module fixes; see note below)
- Module platform: `iphone`
- Runtime target: `macOS` via Mac Catalyst (`-T macos`)
- `ios/manifest` must keep `mac: true`

If you call this outside Mac Catalyst runtime, methods return `ERR_NOT_SUPPORTED_PLATFORM`.

### SDK requirements note

This module needs `mac: true` in the manifest for Mac Catalyst support. Titanium SDK `13.1.1.GA` includes fixes for building Mac Catalyst **apps**, but building **modules** with `mac: true` still needs extra fixes (currently provided by a local/fork SDK build until PR merge).

Required fixes for modules with `mac: true`:

1. **TitaniumKit.xcframework symlink fix**: Mac Catalyst slice needs correct symlinks at the framework root.
2. **Module template updates**: Templates need `SUPPORTED_PLATFORMS` and `SUPPORTS_MACCATALYST` settings.
3. **Build module auto-fix**: CLI should patch legacy modules with `mac: true` during build.

**Future SDK versions**: once the pending PR is merged, this module should work out of the box with the SDK version that includes these fixes (`13.2.0+`, or the version TiDev chooses for release/backport).

## Required entitlements

`example/app.js` is only a UI trigger for module APIs. It will not work as expected unless the **consumer app** includes file entitlements in `tiapp.xml`.

Minimum required:

```xml
<ios>
  <entitlements>
    <dict>
      <key>com.apple.security.files.user-selected.read-write</key>
      <true/>
    </dict>
  </entitlements>
</ios>
```

Without this, dialogs can open, but selected paths may not be usable for read/write.

## Installation

### 1. Build the module

```bash
cd ios
ti build -p ios --build-only --sdk 13.2.0
```

Generated package:

- `ios/dist/ti.macos.panels-iphone-1.0.0.zip`

### 2. Install module in your Titanium app

Add this to your app `tiapp.xml`:

```xml
<modules>
  <module platform="iphone" version="1.0.0">ti.macos.panels</module>
</modules>
```

Install/unpack the built module zip into your Titanium modules path (or your app-local `modules/iphone/...` layout).

### 3. Add Mac entitlements in app `tiapp.xml` (required)

Minimum recommended:

```xml
<ios>
  <entitlements>
    <dict>
      <key>com.apple.security.files.user-selected.read-write</key>
      <true/>
    </dict>
  </entitlements>
</ios>
```

Optional entitlements depending on app behavior:

- `com.apple.security.files.user-selected.read-only`
- `com.apple.security.files.downloads.read-write`
- `com.apple.security.files.bookmarks.app-scope`

## Usage

```js
const macPanel = require('ti.macos.panels')

macPanel.pickFolder({ title: 'Choose a folder' }, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }
  Ti.API.info('Folder: ' + result.path)
})

macPanel.openDocuments({
  title: 'Open documents',
  allowedExtensions: ['txt', 'json']
}, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }
  Ti.API.info(JSON.stringify(result.paths))
})

macPanel.saveFile({
  title: 'Save file',
  defaultName: 'export',
  defaultExtension: 'txt'
}, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }

  // saveFile only picks a destination; your app writes the content.
  Ti.Filesystem.getFile(result.path).write('Generated by ti.macos.panels')
})
```

## Screenshots

GitHub will display light or dark screenshots automatically based on your theme.

### `pickFolder`

![pickFolder (Light)](documentation/images/light-mode/pickFolder.png#gh-light-mode-only)
![pickFolder (Dark)](documentation/images/dark-mode/pickFolder.png#gh-dark-mode-only)

### `pickFile`

![pickFile (Light)](documentation/images/light-mode/pickFile.png#gh-light-mode-only)
![pickFile (Dark)](documentation/images/dark-mode/pickFile.png#gh-dark-mode-only)

### `pickFiles`

![pickFiles (Light)](documentation/images/light-mode/pickFiles.png#gh-light-mode-only)
![pickFiles (Dark)](documentation/images/dark-mode/pickFiles.png#gh-dark-mode-only)

### `openDocument`

![openDocument (Light)](documentation/images/light-mode/openDocument.png#gh-light-mode-only)
![openDocument (Dark)](documentation/images/dark-mode/openDocument.png#gh-dark-mode-only)

### `openDocuments`

![openDocuments (Light)](documentation/images/light-mode/openDocuments.png#gh-light-mode-only)
![openDocuments (Dark)](documentation/images/dark-mode/openDocuments.png#gh-dark-mode-only)

### `saveFile`

![saveFile (Light)](documentation/images/light-mode/saveFile.png#gh-light-mode-only)
![saveFile (Dark)](documentation/images/dark-mode/saveFile.png#gh-dark-mode-only)

## Read selected files with Ti.Filesystem

`ti.macos.panels` returns paths. File I/O is handled with Titanium `Ti.Filesystem`.

Single file:

```js
macPanel.pickFile({ title: 'Choose one file' }, function (result) {
  if (!result.success || !result.path) { return }

  const file = Ti.Filesystem.getFile(result.path)
  const blob = file.read()
  Ti.API.info(blob ? blob.text : '')
})
```

Multiple files:

```js
macPanel.pickFiles({ title: 'Choose files' }, function (result) {
  if (!result.success || !Array.isArray(result.paths)) { return }

  result.paths.forEach(function (selectedPath) {
    const file = Ti.Filesystem.getFile(selectedPath)
    const blob = file.read()
    Ti.API.info(selectedPath + ' -> ' + (blob ? blob.length : 0) + ' bytes')
  })
})
```

## API reference

### `pickFolder(options?, callback?)`

Selects one folder (`NSOpenPanel`).

### `pickFile(options?, callback?)`

Selects one file (`NSOpenPanel`).

### `pickFiles(options?, callback?)`

Selects multiple files (`NSOpenPanel`), controlled by `allowMultiple` (default `true`).

### `openDocument(options?, callback?)`

Same behavior as `pickFile`, with `selectionType: "document"` in the result.

### `openDocuments(options?, callback?)`

Same behavior as `pickFiles`, but always with multi-selection enabled and `selectionType: "documents"`.

### `saveFile(options?, callback?)`

Selects save destination (`NSSavePanel`).

### Alias behavior

These aliases are naming conveniences for intent; native behavior and options stay the same.

- `pickFile` and `openDocument` use the same `NSOpenPanel` flow, with the same options and validation.
- `pickFiles` and `openDocuments` use that same flow too.

The main difference is naming and the `selectionType` value in the result.

- `pickFile` returns `selectionType: "file"`, while `openDocument` returns `selectionType: "document"`.
- `pickFiles` returns `selectionType: "files"`, while `openDocuments` returns `selectionType: "documents"`.
- `openDocuments` always enables multi-selection.
- `pickFiles` can enable or disable multi-selection with `allowMultiple`.

These variants exist to make intent clearer in app code, not to expose different native behavior.

## Options

Common options:

- `title: String`
- `prompt: String`
- `directoryURL: String` (must be an existing directory)
- `showHiddenFiles: Boolean`
- `canCreateDirectories: Boolean`

Open panel options:

- `resolvesAliases: Boolean` (default `true`)
- `allowedExtensions: String | String[]`
- `allowedContentTypes: String | String[]` (UTType identifiers, priority over extensions)
- `allowMultiple: Boolean` (`pickFiles` only)

Save panel options:

- `defaultName: String`
- `defaultExtension: String`

## Unified result contract

All methods return the same object (sync return and callback payload):

```js
{
  paths: String[],
  success: Boolean,
  canceled: Boolean,
  cancelled: Boolean,
  path: String | null,
  code: String | null,
  message: String | null,
  panel: 'open' | 'save',
  fileName: String | null,
  extension: String | null,
  selectionType: 'folder' | 'file' | 'files' | 'document' | 'documents' | 'save'
}
```

## Error codes

- `ERR_NO_SELECTION`
- `ERR_USER_CANCELLED`
- `ERR_INVALID_OPTIONS`
- `ERR_PANEL_UNAVAILABLE`
- `ERR_NOT_SUPPORTED_PLATFORM`
- `ERR_INVALID_START_DIRECTORY`

## Build and test

Build module package:

```bash
cd ios
ti build -p ios --build-only --sdk 13.2.0
```

Run example app (module project example):

```bash
cd ios
ti build -p ios -T macos --sdk 13.2.0
```

If you need to validate native slices directly with Xcode:

```bash
cd ios
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/iphoneos.xcarchive -destination 'generic/platform=iOS' archive
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/iphonesimulator.xcarchive -destination 'generic/platform=iOS Simulator' archive
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/macosx.xcarchive -destination 'generic/platform=macOS,variant=Mac Catalyst' archive
```

## Troubleshooting

### `Could not find a valid Titanium module ... ti.macos.panels`

- Confirm `tiapp.xml` includes module id/version/platform.
- Confirm the built zip is installed in your Titanium modules path or app-local modules directory.

### Panel always cancels or no usable path is returned

- Check that entitlements are set in `tiapp.xml` for user-selected file access.
- Check that the app is built with `-T macos` (Mac Catalyst runtime).

### `ERR_INVALID_OPTIONS`

- Make sure option types match the contract (string/boolean/string-array).
- Make sure `directoryURL` points to an existing directory.

### Titanium CLI build fails before compile

- If CLI fails early, validate native compilation with the `xcodebuild` commands above.

## Contributing

Contributions are welcome.

- Open an issue with reproducible steps for bugs.
- Propose API/behavior changes before large refactors.
- Submit focused PRs with tests/checklist updates (`QA-CHECKLIST.md`) when behavior changes.

## License

MIT. See [`LICENSE`](LICENSE).

## Credits and acknowledgments

- Built with Titanium SDK and TiDev toolchain.
- Uses Apple native panel APIs (`NSOpenPanel`, `NSSavePanel`).
