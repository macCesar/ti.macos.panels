# ti.macos.panels

Native Titanium module for Mac Catalyst file panels.

## Description

`ti.macos.panels` provides a clean JavaScript API on top of Apple native panels:

- `NSOpenPanel` for open/select operations
- `NSSavePanel` for save destination operations

The module is intentionally **Mac Catalyst-only** and returns a unified result contract with standardized error codes across all methods.

## Features

- Folder, file, and multi-file selection
- Document-oriented aliases (`openDocument`, `openDocuments`)
- Save destination picker (`saveFile`)
- Shared callback result shape for all APIs
- Formal `ERR_*` error catalog
- Option validation (including invalid path/type handling)
- File filters via extensions and UTType identifiers

## Compatibility

- **Titanium SDK**: `13.2.0` (local/fork build with Mac Catalyst module fixes; see note below)
- Module platform: `iphone`
- Runtime target: `macOS` via Mac Catalyst (`-T macos`)
- `ios/manifest` must keep `mac: true`

If called outside Mac Catalyst runtime, methods return `ERR_NOT_SUPPORTED_PLATFORM`.

### SDK Requirements Note

This module requires `mac: true` in the manifest for Mac Catalyst support. The Titanium SDK 13.1.1.GA includes fixes for building Mac Catalyst **apps**, but building **modules** with `mac: true` requires additional fixes (currently provided by a local/fork SDK build until PR merge).

Required fixes for modules with `mac: true`:

1. **TitaniumKit.xcframework symlink fix** - Mac Catalyst slice needs proper symlinks at framework root
2. **Module template updates** - Templates need `SUPPORTED_PLATFORMS` and `SUPPORTS_MACCATALYST` settings
3. **Build module auto-fix** - CLI should patch legacy modules with `mac: true` during build

See [`MacCatalyst-Fixes.md`](https://github.com/tidev/titanium-sdk/blob/master/MacCatalyst-Fixes.md) in the Titanium SDK repository for details on these fixes.

**Future SDK versions**: Once the pending PR is merged, this module will work out-of-the-box with the SDK version that incorporates these fixes (`13.2.0+`, or the version selected by TiDev for release/backport).

## Important: Required Entitlements

`example/app.js` is only a UI trigger for the module APIs. It will not work correctly unless the **consumer app** has file entitlements in `tiapp.xml`.

Minimum required:

```xml
<ios>
  <entitlements>
    <dict>
      <key>com.apple.security.files.user-selected.read-write</key>
      <true/>
    </dict>
  </entitlements>
</ios>
```

Without this, dialogs can open but selected paths may not be usable for read/write in your app.

## Installation

### 1) Build the module

```bash
cd ios
ti build -p ios --build-only --sdk 13.2.0
```

Generated package:

- `ios/dist/ti.macos.panels-iphone-1.0.0.zip`

### 2) Install module in your Titanium app

Add to your app `tiapp.xml`:

```xml
<modules>
  <module platform="iphone" version="1.0.0">ti.macos.panels</module>
</modules>
```

Install/unpack the built module zip into your Titanium modules path (or your app-local `modules/iphone/...` layout).

### 3) Add Mac entitlements in app `tiapp.xml` (required)

Minimum recommended:

```xml
<ios>
  <entitlements>
    <dict>
      <key>com.apple.security.files.user-selected.read-write</key>
      <true/>
    </dict>
  </entitlements>
</ios>
```

Optional entitlements depending on your app behavior:

- `com.apple.security.files.user-selected.read-only`
- `com.apple.security.files.downloads.read-write`
- `com.apple.security.files.bookmarks.app-scope`

## Usage

```js
const macPanel = require('ti.macos.panels')

macPanel.pickFolder({ title: 'Choose a folder' }, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }
  Ti.API.info('Folder: ' + result.path)
})

macPanel.openDocuments({
  title: 'Open documents',
  allowedExtensions: ['txt', 'json']
}, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }
  Ti.API.info(JSON.stringify(result.paths))
})

macPanel.saveFile({
  title: 'Save file',
  defaultName: 'export',
  defaultExtension: 'txt'
}, function (result) {
  if (!result.success) {
    Ti.API.warn(result.code + ': ' + result.message)
    return
  }

  // saveFile only chooses destination; your app writes content.
  Ti.Filesystem.getFile(result.path).write('Generated by ti.macos.panels')
})
```

## Read Selected Files with Ti.Filesystem

`ti.macos.panels` returns paths. File I/O is done with Titanium `Ti.Filesystem`.

Single file:

```js
macPanel.pickFile({ title: 'Choose one file' }, function (result) {
  if (!result.success || !result.path) { return }

  const file = Ti.Filesystem.getFile(result.path)
  const blob = file.read()
  Ti.API.info(blob ? blob.text : '')
})
```

Multiple files:

```js
macPanel.pickFiles({ title: 'Choose files' }, function (result) {
  if (!result.success || !Array.isArray(result.paths)) { return }

  result.paths.forEach(function (selectedPath) {
    const file = Ti.Filesystem.getFile(selectedPath)
    const blob = file.read()
    Ti.API.info(selectedPath + ' -> ' + (blob ? blob.length : 0) + ' bytes')
  })
})
```

## API Reference

### `pickFolder(options?, callback?)`

Single folder selection (`NSOpenPanel`).

### `pickFile(options?, callback?)`

Single file selection (`NSOpenPanel`).

### `pickFiles(options?, callback?)`

Multi-file selection (`NSOpenPanel`), controlled by `allowMultiple` (default `true`).

### `openDocument(options?, callback?)`

Document-style alias for single file open (`NSOpenPanel`).

### `openDocuments(options?, callback?)`

Document-style alias for multi-file open (`NSOpenPanel`).

### `saveFile(options?, callback?)`

Save destination selector (`NSSavePanel`).

## Options

Common options:

- `title: String`
- `prompt: String`
- `directoryURL: String` (must be an existing directory)
- `showHiddenFiles: Boolean`
- `canCreateDirectories: Boolean`

Open panel options:

- `resolvesAliases: Boolean` (default `true`)
- `allowedExtensions: String | String[]`
- `allowedContentTypes: String | String[]` (UTType identifiers, priority over extensions)
- `allowMultiple: Boolean` (`pickFiles` only)

Save panel options:

- `defaultName: String`
- `defaultExtension: String`

## Unified Result Contract

All methods return the same object (sync return and callback payload):

```js
{
  paths: String[],
  success: Boolean,
  canceled: Boolean,
  cancelled: Boolean,
  path: String | null,
  code: String | null,
  message: String | null,
  panel: 'open' | 'save',
  fileName: String | null,
  extension: String | null,
  selectionType: 'folder' | 'file' | 'files' | 'document' | 'documents' | 'save'
}
```

## Error Codes

- `ERR_NO_SELECTION`
- `ERR_USER_CANCELLED`
- `ERR_INVALID_OPTIONS`
- `ERR_PANEL_UNAVAILABLE`
- `ERR_NOT_SUPPORTED_PLATFORM`
- `ERR_INVALID_START_DIRECTORY`

## Build and Test

Build module package:

```bash
cd ios
ti build -p ios --build-only --sdk 13.2.0
```

Run example app (module project example):

```bash
cd ios
ti build -p ios -T macos --sdk 13.2.0
```

If you need to validate native slices directly with Xcode:

```bash
cd ios
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/iphoneos.xcarchive -destination 'generic/platform=iOS' archive
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/iphonesimulator.xcarchive -destination 'generic/platform=iOS Simulator' archive
xcodebuild -project ti.macos.panels.xcodeproj -scheme ti.macos.panels -configuration Release -archivePath build/macosx.xcarchive -destination 'generic/platform=macOS,variant=Mac Catalyst' archive
```

## Troubleshooting

### `Could not find a valid Titanium module ... ti.macos.panels`

- Confirm `tiapp.xml` includes module id/version/platform.
- Confirm the built zip is installed in your Titanium modules path or app-local modules directory.

### Panel always cancels or no usable path is returned

- Verify entitlements are set in `tiapp.xml` for user-selected file access.
- Verify your app is built for `-T macos` (Mac Catalyst runtime).

### `ERR_INVALID_OPTIONS`

- Ensure option types match contract (string/boolean/string-array).
- Ensure `directoryURL` points to an existing directory.

### Titanium CLI build fails before compile

- If CLI environment fails early, validate native compilation with `xcodebuild` commands shown above.

## Contributing

Contributions are welcome.

- Open an issue with reproducible steps for bugs.
- Propose API/behavior changes before large refactors.
- Submit focused PRs with tests/checklist updates (`QA-CHECKLIST.md`) when behavior changes.

## License

MIT. See [`LICENSE`](LICENSE).

## Credits and Acknowledgments

- Built with Titanium SDK and TiDev toolchain.
- Uses Apple native panel APIs (`NSOpenPanel`, `NSSavePanel`).
